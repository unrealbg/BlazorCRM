@using Crm.Application.Services
@using Crm.Domain.Enums
@using Crm.UI.Components
@using Microsoft.AspNetCore.Identity
@using Crm.Application.Security

<div class="space-y-3">
  <div class="flex items-center gap-2">
    <AuthorizeView Policy="@Permissions.Activities_Write">
      <button class="btn btn-primary" @onclick="() => _editor.Show(null)">New Activity</button>
    </AuthorizeView>
    <select class="select w-48" @bind="_filterType">
      <option value="">All types</option>
      @foreach (var t in Enum.GetValues<ActivityType>())
      {
        <option value="@t.ToString()">@t</option>
      }
    </select>
    <select class="select w-48" @bind="_filterStatus">
      <option value="">All statuses</option>
      @foreach (var s in Enum.GetValues<ActivityStatus>())
      {
        <option value="@s.ToString()">@s</option>
      }
    </select>
    <button class="btn btn-muted" @onclick="Reload">Apply</button>
  </div>

  @if (_loading)
  {
    <div>Loading…</div>
  }
  else if (!_items.Any())
  {
    <div class="text-slate-500">No activities</div>
  }
  else
  {
    <ActivityTimeline Items="_items" ItemTemplate="@TimelineTemplate" />
  }

  <AuthorizeView Policy="@Permissions.Activities_Write">
    <ActivityEditor @ref="_editor" RelatedTo="RelatedTo" RelatedId="RelatedId" OnSaved="Reload" />
    <ConfirmModal @ref="_confirm" Title="Delete" Message="Delete this item?" OnConfirmed="ConfirmDeleteAsync" />
  </AuthorizeView>
</div>

@code {
  [Parameter] 
  public RelatedToType RelatedTo { get; set; }

  [Parameter] 
  public Guid RelatedId { get; set; }

  [Inject] 
  IActivityService Service { get; set; } = default!;

  [Inject] 
  UserManager<IdentityUser> UserManager { get; set; } = default!;

  bool _loading = true;
  List<ActivityTimelineItem> _items = new();
  string? _filterType;
  string? _filterStatus;

  List<IdentityUser> _users = new();

  ActivityEditor _editor = default!;
  ConfirmModal _confirm = default!;
  Guid _pendingDeleteId;

  RenderFragment<ActivityTimelineItem> TimelineTemplate => item =>
  @<li class="flex items-start gap-3 p-3 rounded-xl hover:bg-white/60 dark:hover:bg-slate-800/40">
      <span class="shrink-0 inline-flex h-8 w-8 items-center justify-center rounded-full bg-white/70 dark:bg-slate-800/60 border border-white/40 dark:border-white/10">@item.Icon</span>
      <div class="min-w-0">
        <div class="font-medium truncate">@item.Title</div>
        @if (!string.IsNullOrWhiteSpace(item.Subtitle) || !string.IsNullOrWhiteSpace(item.LinkHref))
        {
            <div class="text-sm text-slate-500 dark:text-slate-400 truncate">
                @item.Subtitle
                @if (!string.IsNullOrWhiteSpace(item.LinkHref))
                {
                    <a class="link ml-2" href="@item.LinkHref">@(item.LinkLabel ?? "Open")</a>
                }
            </div>
        }
        @if (item.WhenUtc is not null)
        {
            <div class="text-xs text-slate-400">@item.WhenUtc.Value.ToLocalTime().ToString("g") @if(!string.IsNullOrWhiteSpace(item.Status)){<span class="ml-2 chip">@item.Status</span>}</div>
        }
      </div>
      <AuthorizeView Policy="@Permissions.Activities_Write">
        <div class="ml-auto pl-2 inline-flex gap-2">
          <button class="link" @onclick="() => _editor.Show(item.Id)">Edit</button>
          <button class="link text-rose-500" @onclick="() => AskDelete(item.Id)">Delete</button>
        </div>
      </AuthorizeView>
    </li>;

  protected override async Task OnParametersSetAsync()
  {
    _users = UserManager.Users.ToList();
    await Reload();
  }

  private async Task Reload()
  {
    _loading = true;
    var data = await Service.GetAllAsync(RelatedId);

    if (!string.IsNullOrEmpty(_filterType) && Enum.TryParse<ActivityType>(_filterType, out var ft))
      data = data.Where(a => a.Type == ft);

    if (!string.IsNullOrEmpty(_filterStatus) && Enum.TryParse<ActivityStatus>(_filterStatus, out var fs))
      data = data.Where(a => a.Status == fs);

    _items = data
      .OrderByDescending(a => a.DueAt ?? DateTime.MaxValue)
      .Select(a => new ActivityTimelineItem(
        Icon: a.Type switch { ActivityType.Call => "??", ActivityType.Meeting => "??", ActivityType.Email => "??", _ => "??" },
        Title: a.Notes ?? a.Type.ToString(),
        Subtitle: a.OwnerId is Guid oid ? $"Owner: {OwnerName(oid)}" : null,
        WhenUtc: a.DueAt,
        Status: a.Status.ToString(),
        LinkHref: RelatedTo switch { RelatedToType.Company => $"/companies/{RelatedId}", RelatedToType.Contact => $"/contacts/{RelatedId}", RelatedToType.Deal => $"/deals/{RelatedId}", _ => null },
        LinkLabel: RelatedTo.ToString(),
        Id: a.Id
      ))
      .ToList();
    _loading = false;
  }

  private void AskDelete(Guid? id)
  {
    _pendingDeleteId = id ?? Guid.Empty;
    if (_pendingDeleteId != Guid.Empty) _confirm.Show();
  }

  private async Task ConfirmDeleteAsync()
  {
    if (_pendingDeleteId == Guid.Empty) return;
    await Service.DeleteAsync(_pendingDeleteId);
    _pendingDeleteId = Guid.Empty;
    await Reload();
  }

  string OwnerName(Guid id)
  {
    var u = _users.FirstOrDefault(x => x.Id == id.ToString());
    return u is null ? id.ToString() : DisplayName(u);
  }

  static string DisplayName(IdentityUser u)
    => string.IsNullOrWhiteSpace(u.Email) ? (u.UserName ?? u.Id) : u.Email!;
}
