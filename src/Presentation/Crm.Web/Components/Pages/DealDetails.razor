@page "/deals/{Id:guid}"
@using Crm.Application.Services
@using Crm.Domain.Entities
@using Crm.Domain.Enums
@using Microsoft.AspNetCore.Components.Forms
@using Crm.Application.Security

<h1 class="text-2xl font-semibold mb-4">Deal details</h1>

<div class="grid lg:grid-cols-3 gap-4">
  <div class="card p-4 lg:col-span-2">
    @if (_loading)
    {
      <div>Loading...</div>
    }
    else if (_deal is null)
    {
      <div class="text-slate-500">Not found</div>
    }
    else
    {
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-xl font-semibold">@_deal.Title</div>
          <AuthorizeView Policy="@Permissions.Deals_Write">
            <Authorized Context="auth">
              <button class="btn btn-muted" @onclick="() => _editModal.Show()">Edit</button>
            </Authorized>
          </AuthorizeView>
        </div>
        <div class="text-slate-500">Amount: @_deal.Amount.ToString("C0") @_deal.Currency</div>
        <div class="text-slate-500">Probability: @_deal.Probability%</div>
        <div class="text-slate-500">Stage: @(_stageName ?? _deal.StageId.ToString())</div>
        @if (_deal.CompanyId is Guid cid) 
        { 
            <div><a class="link" href="/companies/@cid">Company @cid</a></div> 
        }

        @if (_deal.ContactId is Guid coid) 
        { 
            <div><a class="link" href="/contacts/@coid">Contact @coid</a></div> 
        }

        <div class="mt-4">
          <div class="font-semibold mb-2">Attachments</div>
          <AuthorizeView Policy="@Permissions.Attachments_Write">
            <Authorized Context="auth2">
              <InputFile OnChange="OnUpload" />
            </Authorized>
          </AuthorizeView>
          <ul class="mt-2 space-y-1">
            @foreach (var a in _attachments)
            {
              <li class="flex items-center justify-between text-sm">
                <a class="link" href="/attachments/@a.Id">@a.FileName</a>
                <AuthorizeView Policy="@Permissions.Attachments_Write">
                  <Authorized Context="auth3">
                    <button class="link text-rose-500" @onclick="() => AskDeleteAttachment(a.Id)">Delete</button>
                  </Authorized>
                </AuthorizeView>
              </li>
            }
          </ul>
        </div>
      </div>
    }
  </div>

  <div class="card p-4">
    <div class="font-semibold mb-2">Activities</div>
    <ActivitiesList RelatedTo="RelatedToType.Deal" RelatedId="Id" />
  </div>
</div>

<AuthorizeView Policy="@Permissions.Deals_Write">
  <Authorized Context="auth4">
    <Modal @ref="_editModal" Title="Edit deal">
      @if (_deal is not null)
      {
        <EditForm Model="_deal" OnValidSubmit="SaveAsync">
          <DataAnnotationsValidator />
          <div class="space-y-3">
            <input class="input" @bind="_deal.Title" />
            <div class="grid grid-cols-3 gap-2">
              <input class="input" type="number" step="0.01" @bind-value="_deal.Amount" @bind-value:event="oninput" />
              <input class="input" @bind="_deal.Currency" />
              <input class="input" type="number" min="0" max="100" @bind-value="_deal.Probability" @bind-value:event="oninput" />
            </div>
            <div class="flex justify-end gap-2">
              <button type="button" class="btn btn-muted" @onclick="() => _editModal.Hide()">Cancel</button>
              <button class="btn btn-primary">Save</button>
            </div>
          </div>
        </EditForm>
      }
    </Modal>
  </Authorized>
</AuthorizeView>

<ConfirmModal @ref="_confirm" Title="Delete Attachment" Message="Are you sure you want to delete this attachment?" OnConfirmed="ConfirmDeleteAttachmentAsync" />


