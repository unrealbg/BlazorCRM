@page "/deals"
@using Crm.Application.Services
@using Crm.Domain.Entities
@using Crm.UI.Components
@using Crm.UI.Components.Base
@using Crm.Application.Security

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">Deals</h1>
    <div class="text-xs text-slate-500">Drag and drop across stages or open a deal to edit.</div>
  </div>
  <UiButton Variant="primary" OnClick="Reload">Refresh</UiButton>
</div>

<UiCard Class="p-4 space-y-3">
  <div class="flex flex-wrap items-center gap-2">
    <label class="text-xs uppercase tracking-wide text-slate-500">Pipeline</label>
    <InputSelect class="ui-select w-60" @bind-Value="SelectedPipelineId">
      @foreach (var p in _pipelines)
      {
        <option value="@p.Id">@p.Name</option>
      }
    </InputSelect>
    <UiButton Variant="muted" OnClick="Reload">Reload</UiButton>
  </div>

  @if (_loading)
  {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      @for (var i = 0; i < 4; i++)
      {
        <UiCard Class="p-3">
          <UiSkeleton Style="height:14px;width:120px" />
          <div class="mt-2 space-y-2">
            <UiSkeleton Style="height:48px" />
            <UiSkeleton Style="height:48px" />
          </div>
        </UiCard>
      }
    </div>
  }
  else if (_stages.Count == 0)
  {
    <UiEmptyState Title="No stages" Description="This pipeline has no stages yet." />
  }
  else
  {
    <div class="hidden md:block">
      <div class="crm-kanban">
        <div class="crm-kanban-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          @foreach (var s in _stages)
          {
            var list = _dealsByStage.TryGetValue(s.Id, out var v) ? v : new List<Deal>();
            var hovered = _hoveredStageId == s.Id;
            <StageColumn Title="@s.Name" Count="@list.Count" Class="@($"crm-kanban-col {(hovered ? "ring-2 ring-brand-500/50" : string.Empty)}")" OnDrop="e => OnDropAsync(s.Id)" OnDragOver="OnDragOver" OnDragEnter="e => OnDragEnter(s.Id)" OnDragLeave="e => OnDragLeave(s.Id)">
              <div class="space-y-2 min-h-10">
                @foreach (var d in list)
                {
                  var isGhost = _ghostDealId == d.Id;
                <AuthorizeView Policy="@Permissions.Deals_Move">
                  <Authorized Context="auth">
                    <div class="ui-card crm-deal-card transition-opacity cursor-pointer @(isGhost ? "crm-deal-ghost" : string.Empty)" draggable="true" @ondragstart="e => OnDragStart(d)" @onclick="() => OpenDrawer(d)">
                      <div class="flex items-start justify-between gap-2">
                        <div class="min-w-0">
                          <div class="font-semibold truncate">@d.Title</div>
                          <div class="text-xs text-slate-500">@d.Amount.ToString("C0") @if(!string.IsNullOrEmpty(d.Currency)){<span class="ml-1">@d.Currency</span>}</div>
                        </div>
                        <button class="crm-deal-move md:hidden" type="button" @onclick="() => OpenMoveSheet(d)" @onclick:stopPropagation="true">Move</button>
                      </div>
                      <div class="mt-2 text-xs text-slate-500 crm-deal-meta">
                        <span class="truncate">@DealPartyLabel(d)</span>
                        <span class="mx-1 text-slate-300">•</span>
                        <span class="truncate">@OwnerName(d.OwnerId)</span>
                      </div>
                      <button class="crm-deal-more md:hidden" type="button" @onclick="() => ToggleDealDetails(d.Id)" @onclick:stopPropagation="true">@(IsDealExpanded(d.Id) ? "Less" : "More")</button>
                      <div class="crm-deal-more-panel @(IsDealExpanded(d.Id) ? "is-open" : string.Empty)">
                        <div class="text-xs text-slate-500">Stage: @(_stageNameMap.TryGetValue(d.StageId, out var stageName) ? stageName : "Stage")</div>
                        <div class="text-xs text-slate-500">Probability: @d.Probability%</div>
                        @if (d.CloseDate is not null)
                        {
                          <div class="text-xs text-slate-500">Close: @d.CloseDate.Value.ToString("d")</div>
                        }
                      </div>
                    </div>
                  </Authorized>
                  <NotAuthorized>
                    <div class="ui-card crm-deal-card cursor-pointer" @onclick="() => OpenDrawer(d)">
                      <div class="flex items-start justify-between gap-2">
                        <div class="min-w-0">
                          <div class="font-semibold truncate">@d.Title</div>
                          <div class="text-xs text-slate-500">@d.Amount.ToString("C0") @if(!string.IsNullOrEmpty(d.Currency)){<span class="ml-1">@d.Currency</span>}</div>
                        </div>
                      </div>
                      <div class="mt-2 text-xs text-slate-500 crm-deal-meta">
                        <span class="truncate">@DealPartyLabel(d)</span>
                        <span class="mx-1 text-slate-300">•</span>
                        <span class="truncate">@OwnerName(d.OwnerId)</span>
                      </div>
                    </div>
                  </NotAuthorized>
                </AuthorizeView>
              }
            </div>
          </StageColumn>
        }
      </div>
    </div>
    </div>

    <div class="block md:hidden overflow-x-auto">
      <div class="flex gap-3 pb-2" style="min-width: min-content;">
        @foreach (var s in _stages)
        {
          var list = _dealsByStage.TryGetValue(s.Id, out var v) ? v : new List<Deal>();
          <div class="flex-shrink-0" style="width: 85vw;">
            <UiCard Class="p-3">
              <div class="flex items-center justify-between mb-3">
                <div class="font-semibold text-sm">@s.Name</div>
                <div class="text-xs text-slate-500">@list.Count</div>
              </div>
              <div class="space-y-2 min-h-10">
                @foreach (var d in list)
                {
                  <div class="ui-card crm-deal-card cursor-pointer" @onclick="() => OpenDrawer(d)">
                    <div class="flex items-start justify-between gap-2">
                      <div class="min-w-0 flex-1">
                        <div class="font-semibold">@d.Title</div>
                        <div class="text-xs text-slate-500 mt-1">@d.Amount.ToString("C0") @if(!string.IsNullOrEmpty(d.Currency)){<span class="ml-1">@d.Currency</span>}</div>
                      </div>
                      <AuthorizeView Policy="@Permissions.Deals_Move">
                        <Authorized>
                          <button class="px-3 py-1.5 text-xs font-medium bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 whitespace-nowrap" type="button" @onclick="() => OpenMoveSheet(d)" @onclick:stopPropagation="true">Move</button>
                        </Authorized>
                      </AuthorizeView>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">
                      <span class="truncate">@DealPartyLabel(d)</span>
                    </div>
                  </div>
                }
              </div>
            </UiCard>
          </div>
        }
      </div>
    </div>
  }
</UiCard>

<AuthorizeView Policy="@Permissions.Deals_Move">
  <Authorized>
    @if (_showMoveSheet && _moveDeal is not null)
    {
      <div class="crm-mobile-sheet" role="dialog" aria-label="Move deal">
        <div class="crm-mobile-sheet-backdrop" @onclick="CloseMoveSheet"></div>
        <div class="crm-mobile-sheet-panel">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-sm truncate">Move "@_moveDeal.Title"</div>
            <button class="crm-sheet-close" type="button" @onclick="CloseMoveSheet">Close</button>
          </div>
          <div class="space-y-1">
            @foreach (var s in _stages)
            {
              var isCurrent = _moveDeal.StageId == s.Id;
              <button class="crm-sheet-item @(isCurrent ? "is-active" : string.Empty)" type="button" @onclick="() => MoveDealToStageMobileAsync(_moveDeal!, s.Id)">
                <span>@s.Name</span>
                @if (isCurrent)
                {
                  <span class="text-xs text-slate-500">Current</span>
                }
              </button>
            }
          </div>
        </div>
      </div>
    }
  </Authorized>
</AuthorizeView>

<UiDrawer @bind-Open="_drawerOpen" Title="Deal quick edit">
  @if (_drawerDeal is null)
  {
    <UiEmptyState Title="No deal selected" Description="Select a deal card to view details." />
  }
  else
  {
    <div class="space-y-4">
      <UiCard Class="p-3">
        <div class="text-sm font-semibold">@_drawerDeal.Title</div>
        <div class="text-xs text-slate-500">@_drawerDeal.Amount.ToString("C0") @_drawerDeal.Currency</div>
        <div class="mt-2"><UiBadge>@(_stageNameMap.TryGetValue(_drawerDeal.StageId, out var sname) ? sname : "Stage")</UiBadge></div>
      </UiCard>

      <AuthorizeView Policy="@Permissions.Deals_Write">
        <Authorized Context="auth">
          <EditForm Model="_editDeal" OnValidSubmit="SaveQuickEditAsync">
            <DataAnnotationsValidator />
            <div class="space-y-2">
              <InputText class="ui-input" @bind-Value="_editDeal!.Title" />
              <div class="grid grid-cols-2 gap-2">
                <InputNumber class="ui-input" @bind-Value="_editDeal!.Amount" />
                <InputText class="ui-input" @bind-Value="_editDeal!.Currency" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <InputNumber class="ui-input" @bind-Value="_editDeal!.Probability" />
                <InputSelect class="ui-select" @bind-Value="_editDeal!.StageId">
                  @foreach (var s in _stages)
                  {
                    <option value="@s.Id">@s.Name</option>
                  }
                </InputSelect>
              </div>
              <div class="flex justify-end gap-2">
                <UiButton Variant="muted" OnClick="CloseDrawer">Close</UiButton>
                <UiButton Variant="primary">Save</UiButton>
              </div>
            </div>
          </EditForm>
        </Authorized>
      </AuthorizeView>

      <UiCard Class="p-3">
        <div class="text-sm font-semibold mb-2">Timeline</div>
        @if (_loadingTimeline)
        {
          <div class="space-y-2">
            <UiSkeleton Style="height:52px" />
            <UiSkeleton Style="height:52px" />
          </div>
        }
        else
        {
          <ActivityTimeline Items="_timeline" />
        }
      </UiCard>
    </div>
  }
</UiDrawer>


