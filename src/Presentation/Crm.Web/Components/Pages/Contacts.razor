@page "/contacts"
@using Crm.Domain.Entities

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">Contacts</h1>
    <div class="text-xs text-slate-500">Manage people, ownership, and tags.</div>
  </div>
  <div class="flex items-center gap-2">
    <UiButton Variant="primary" OnClick="Reload">Refresh</UiButton>
  </div>
</div>

<UiCard Class="p-4 mb-4">
  <div class="flex flex-wrap items-center gap-2">
    <div class="min-w-[220px] flex-1">
      <UiInput @bind-Value="_search" Placeholder="Search contacts..." />
    </div>
    <div class="w-36 hidden md:block">
      <InputSelect class="ui-select" @bind-Value="_pageSize">
        <option value="5">5 / page</option>
        <option value="10">10 / page</option>
        <option value="20">20 / page</option>
      </InputSelect>
    </div>
    <UiButton Variant="muted" OnClick="Reload">Apply</UiButton>
    <div class="ml-auto text-xs text-slate-500">@(_total) results</div>
  </div>
</UiCard>

<div class="hidden md:block">
<UiCard Class="p-0 crm-table-wrap">
  <UiTable Class="min-w-full text-sm">
    <thead class="bg-white/50 dark:bg-slate-800/40">
      <tr class="text-slate-600 dark:text-slate-300">
        <th class="px-4 py-3 text-left cursor-pointer" @onclick="() => SortBy(nameof(Contact.LastName))">Name @SortGlyph(nameof(Contact.LastName))</th>
        <th class="px-4 py-3 text-left">Company</th>
        <th class="px-4 py-3 text-left">Email</th>
        <th class="px-4 py-3 text-left">Phone</th>
        <th class="px-4 py-3 text-left">Tags</th>
        <th class="px-4 py-3 text-right">Actions</th>
      </tr>
    </thead>
    <tbody>
      @if (_loading)
      {
        @for (var i = 0; i < 5; i++)
        {
          <tr class="border-t border-white/40 dark:border-white/10">
            <td class="px-4 py-3"><UiSkeleton Style="height:14px;width:160px" /></td>
            <td class="px-4 py-3"><UiSkeleton Style="height:14px;width:120px" /></td>
            <td class="px-4 py-3"><UiSkeleton Style="height:14px;width:140px" /></td>
            <td class="px-4 py-3"><UiSkeleton Style="height:14px;width:120px" /></td>
            <td class="px-4 py-3"><UiSkeleton Style="height:14px;width:100px" /></td>
            <td class="px-4 py-3 text-right"><UiSkeleton Style="height:14px;width:80px;display:inline-block" /></td>
          </tr>
        }
      }
      else if (!_items.Any())
      {
        <tr><td class="px-4 py-6" colspan="6"><UiEmptyState Title="No contacts" Description="Try adjusting your search or add a new contact." /></td></tr>
      }
      else
      {
        @foreach (var c in _items)
        {
          <tr class="border-t border-white/40 dark:border-white/10">
            <td class="px-4 py-3 font-medium">@DisplayName(c)</td>
            <td class="px-4 py-3 text-slate-500">@CompanyLabel(c.CompanyId)</td>
            <td class="px-4 py-3">@c.Email</td>
            <td class="px-4 py-3">@c.Phone</td>
            <td class="px-4 py-3">
              @if (c.Tags?.Count > 0)
              {
                <div class="flex flex-wrap gap-1">
                  @foreach (var t in c.Tags)
                  {
                    <span class="chip">@t</span>
                  }
                </div>
              }
            </td>
            <td class="px-4 py-3 text-right">
              <a class="link" href="/contacts/@c.Id">Open</a>
            </td>
          </tr>
        }
      }
    </tbody>
  </UiTable>
</UiCard>

@if (_pages > 1)
{
  <div class="mt-3 flex items-center justify-between gap-2 text-sm">
    <div>Showing @StartRow-@EndRow of @_total</div>
    <div class="inline-flex gap-2">
      <UiButton Variant="muted" Disabled="@(_page==1)" OnClick="PrevPage">Prev</UiButton>
      <UiButton Variant="muted" Disabled="@(_page==_pages)" OnClick="NextPage">Next</UiButton>
    </div>
  </div>
}
</div>

<div class="block md:hidden">
  @if (_loading && _mobilePage == 1)
  {
    @for (var i = 0; i < 5; i++)
    {
      <UiCard Class="p-4 mb-3">
        <div class="space-y-2">
          <UiSkeleton Style="height:18px;width:70%" />
          <UiSkeleton Style="height:14px;width:50%" />
          <UiSkeleton Style="height:14px;width:60%" />
        </div>
      </UiCard>
    }
  }
  else if (!_mobileItems.Any())
  {
    <UiCard Class="p-4">
      <UiEmptyState Title="No contacts" Description="Try adjusting your search or add a new contact." />
    </UiCard>
  }
  else
  {
    @foreach (var c in _mobileItems)
    {
      <UiCard Class="p-4 mb-3">
        <div class="flex flex-col gap-3">
          <div>
            <div class="font-semibold text-base">@DisplayName(c)</div>
            @if (!string.IsNullOrWhiteSpace(CompanyLabel(c.CompanyId)))
            {
              <div class="text-sm text-slate-500 mt-1">@CompanyLabel(c.CompanyId)</div>
            }
          </div>
          
          @if (!string.IsNullOrWhiteSpace(c.Phone))
          {
            <div class="text-sm flex items-center gap-2">
              <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              @c.Phone
            </div>
          }
          
          @if (!string.IsNullOrWhiteSpace(c.Email))
          {
            <div class="text-sm flex items-center gap-2">
              <svg viewBox="0 0 24 24" class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              @c.Email
            </div>
          }
          
          @if (c.Tags?.Count > 0)
          {
            <div class="flex flex-wrap gap-1">
              @foreach (var t in c.Tags)
              {
                <span class="chip">@t</span>
              }
            </div>
          }
          
          <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-200 dark:border-slate-700">
            @if (!string.IsNullOrWhiteSpace(c.Phone))
            {
              <a class="btn btn-muted flex-1 min-h-[44px]" href="tel:@c.Phone">
                <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                Call
              </a>
            }
            @if (!string.IsNullOrWhiteSpace(c.Email))
            {
              <a class="btn btn-muted flex-1 min-h-[44px]" href="mailto:@c.Email">
                <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                Email
              </a>
            }
            <a class="btn btn-primary flex-1 min-h-[44px]" href="/contacts/@c.Id">Open</a>
          </div>
        </div>
      </UiCard>
    }
  }

  @if (!_loading && _mobilePage < _pages)
  {
    <div class="mt-3">
      <UiButton Variant="primary" Class="w-full min-h-[48px]" OnClick="LoadMoreMobile" Disabled="@_loading">
        @if (_loading) { <span>Loading...</span> } else { <span>Load more</span> }
      </UiButton>
      <div class="mt-2 text-xs text-slate-500 text-center">Showing @_mobileItems.Count of @_total</div>
    </div>
  }
</div>
